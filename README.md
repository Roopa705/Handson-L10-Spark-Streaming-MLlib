# Hands-on L10: Spark Structured Streaming + Machine Learning with MLlib

## Overview
This hands-on assignment demonstrates a **real-time streaming and machine learning pipeline** using **Apache Spark Structured Streaming** and **Spark MLlib**.  
It includes two major components:

- **Task 4 â€” Real-Time Fare Prediction**  
  A regression model that predicts fare amounts in real time based on ride distance.

- **Task 5 â€” Time-Based Fare Trend Prediction**  
  A time-series regression model that predicts average fare trends over time windows.

Both tasks use **streaming data** generated by `data_generator.py` and consume it in Spark using a socket stream.

---

## Repository Structure

```
HANDS-ON-10--STREAMING-AND-MACHINE-LEARNING/
â”œâ”€â”€ data_generator.py
â”œâ”€â”€ task4.py
â”œâ”€â”€ task5.py
â”œâ”€â”€ training-dataset.csv
â”œâ”€â”€ README.md
â”‚
â”œâ”€â”€ models/
â”‚
â”œâ”€â”€ Screenshots of the Installations/
â”‚   â”œâ”€â”€ installation_screenshot1.png
â”‚   â”œâ”€â”€ installation_screenshot2.png
â”‚   â””â”€â”€ ...
â”‚
â””â”€â”€ Screenshots of the Outputs/
    â”œâ”€â”€ task4_output.png
    â”œâ”€â”€ task5_output.png
    â””â”€â”€ ...
```

---

## Setup Instructions

### Install Dependencies
```bash
pip install pyspark faker
```

---

### Step 1: Start the Data Generator
Run this in **Terminal 1**:
```bash
python3 data_generator.py
```

You should see output similar to:
```bash
Streaming data to localhost:9999...
Sent: {"trip_id":"...","driver_id":17,"distance_km":23.45,"fare_amount":67.20,"timestamp":"2025-10-21 17:30:00"}
```
This indicates that the generator is streaming continuous JSON events to `localhost:9999`.

---

## Task 4 â€“ Real-Time Fare Prediction

### Goal
Train and deploy a **Linear Regression** model to predict the fare amount from the `distance_km` field and evaluate real-time predictions on incoming data.

### Model Training
* Load `training-dataset.csv`
* Convert columns to numeric types
* Assemble features using `VectorAssembler(inputCols=["distance_km"])`
* Train a regression model (`LinearRegression`)
* Save the trained model under `models/`

### Streaming Inference
* Parse live JSON records from the socket
* Assemble features
* Use the trained model to predict fares
* Compute `deviation = |actual âˆ’ predicted|`
* Continuously display results on the console

### Run
In **Terminal 2** (keep generator running):
```bash
python3 task4.py
```

### Sample Output
```diff
trip_id | driver_id | distance_km | fare_amount | predicted_fare | deviation
---------------------------------------------------------------------------
cf30c1b1-d090-42bd-82e5-6ff59a12bab5 | 72 | 39.93 | 134.18 | 88.33 | 45.85
ef861f11-0729-41fe-9bb3-400f890ae604 | 53 | 21.96 | 107.17 | 92.75 | 14.41
```

---

## Task 5 â€“ Time-Based Fare Trend Prediction

### Goal
Predict **average fare trends** in real time using **5-minute window aggregations** and time-based features (`hour_of_day`, `minute_of_hour`).

### Model Training
* Aggregate historical fares into 5-minute windows  
* Compute `avg_fare` per window  
* Add time-based features  
* Train a regression model to predict the next windowâ€™s average fare  
* Save it under `models/`

### Streaming Inference
* Read data from the same socket stream  
* Perform sliding 5-minute window aggregation (slide every 1 minute)  
* Apply the trained model for trend prediction  

### Run
In **Terminal 3**:
```bash
python3 task5.py
```

### Sample Output
```yaml
window_start          | window_end            | avg_fare | predicted_next_avg_fare
-------------------------------------------------------------------------------
2025-10-21 21:29:00   | 2025-10-21 21:34:00   | 76.05    | 92.39
2025-10-21 21:30:00   | 2025-10-21 21:35:00   | 79.12    | 90.81
```

---

## Key Concepts Used

| Concept                    |	Description                                                             |
|----------------------------|-------------------------------------------------------------------------|
| Spark Structured Streaming |	Handles continuous ingestion of live data via sockets.                  |
| VectorAssembler            |	Converts numeric columns into MLlib feature vectors.                    |
| LinearRegression (MLlib)   |	Learns regression models for fare and trend prediction.                 |
| Window Aggregations        |	Groups streaming data into fixed-size time windows for trend detection. |
| Pipeline Consistency       |	Ensures identical preprocessing in training and inference stages.       |

---

## Screenshots

- **Screenshots of the Installations**: Verifies Spark and Python environment setup.  
- **Screenshots of the Outputs**: Shows successful execution of Task 4 and Task 5 with streaming results.

---

## Submission Checklist

âœ… `data_generator.py` â€” Streams JSON ride data  
âœ… `task4.py` â€” Trains & predicts real-time fares  
âœ… `task5.py` â€” Trains & predicts fare trends  
âœ… `training-dataset.csv` â€” Used for model training  
âœ… Screenshots of Installations & Outputs  
âœ… `README.md` â€” Updated and documented  

---

## Results

Both **Task 4** and **Task 5** executed successfully:

- **Task 4**: Produced continuous fare predictions with computed deviations.  
- **Task 5**: Captured average fare patterns dynamically across 5-minute windows.

ðŸš€ **Demonstrates a complete end-to-end real-time streaming ML pipeline in Apache Spark.**
# Handson-L10-Spark-Streaming-MLlib
